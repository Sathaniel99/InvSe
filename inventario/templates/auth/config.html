{% extends "dashboard_template.html" %}
{% load static %}

{% block content_dashboard %}
<style>
    section {
        display: flex;
        overflow: hidden;
        position: relative;
    }
    .photo-button {
        width: 3.5rem;
        height: 3.5rem;
        background-color: var(--bs-secondary-bg-subtle);
        line-height: 1rem;
        box-shadow: 0 0 6px rgba(123, 123, 123, 0.78);
        transition: all 0.2s ease;
    }
    .photo-button:hover {
        background-color: rgb(176, 176, 176);
        color: rgb(219, 218, 218);
    }
    .photo-button:active {
        background-color: rgb(67, 67, 67);
        color: rgb(255, 255, 255);
    }
    .photo-container:hover + .photo-button {
        background-color: rgb(176, 176, 176);
        color: rgb(219, 218, 218);
    }
    .photo-container:active + .photo-button {
        background-color: rgb(67, 67, 67);
        color: rgb(255, 255, 255);
    }
</style>

<!-- Modal para cambiar foto -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content bg-invert shadow">
            <div class="modal-header">
                <h5 class="modal-title">Cambiar foto de perfil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form action="{% url 'update-self-photo' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row justify-content-center align-items-center g-4">
                        <!-- Foto actual -->
                        <div class="col-md-6 text-center">
                            <div class="border border-2 border-secondary-subtle bg-secondary-subtle-hover transition-200 rounded-circle d-flex align-items-center justify-content-center overflow-hidden mx-auto"
                                style="width: 200px; height: 200px;">
                                {% if request.user.img %}
                                <img src="{{ request.user.img.url }}" class="img-fluid h-100 w-100 object-fit-cover" 
                                     alt="Foto actual de {{ request.user.get_full_name }}">
                                {% else %}
                                <i class="bi bi-person text-secondary" style="font-size: 5rem;"></i>
                                {% endif %}
                            </div>
                            <p class="small text-muted mt-2">Foto actual</p>
                        </div>

                        <!-- Nueva foto -->
                        <div class="col-md-6 text-center">
                            <div class="border border-2 border-secondary-subtle bg-secondary-subtle-hover transition-200 rounded-circle d-flex align-items-center justify-content-center overflow-hidden mx-auto position-relative"
                                style="width: 200px; height: 200px;">
                                <input type="file" name="imageUpload" id="imageUpload"
                                    class="position-absolute top-0 start-0 w-100 h-100 opacity-0 cursor-pointer"
                                    accept="image/*">
                                <i class="bi bi-cloud-arrow-up text-secondary" style="font-size: 5rem;" id="uploadIcon"></i>
                                <img id="uploadPreview" class="img-fluid h-100 w-100 object-fit-cover d-none" 
                                     src="" alt="Vista previa de nueva foto">
                            </div>
                            <p class="small text-muted m-0">Nueva foto</p>
                            <div class="form-text m-0">Formatos: JPG, PNG (Máx. 5MB)</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="submit" class="btn btn-outline-black">
                        <i class="bi bi-check-circle me-1"></i> Guardar cambios
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Contenido principal -->
<div class="container-fluid p-0 border border-1 border-secondary-subtle rounded-2">
    <div class="d-flex flex-column p-4 w-100 position-relative">
        <div class="form-label fw-semibold small text-uppercase text-muted position-absolute top-0 end-0 mt-3 me-4">
            {{ request.user.tipo_user }} / {{ request.user.area.nombre }}
        </div>
        <h1 class="fw-semibold mb-4 text-start">Datos de usuario</h1>
        
        <div class="row g-4">
            <!-- Foto de perfil -->
            <div class="col-md-12 col-md-12 col-xl-4 d-flex justify-content-center align-items-start">
                <div class="position-relative">
                    <div class="photo-container d-flex align-items-center justify-content-center bg-secondary-subtle bg-primary-subtle-hover transition-200 rounded-circle shadow border border-2 border-secondary overflow-hidden"
                        role="button" data-bs-toggle="modal" data-bs-target="#photoModal" 
                        style="width: 20rem; height: 20rem;">
                        {% if request.user.img %}
                        <img class="img-fluid h-100 w-100 object-fit-cover" src="{{ request.user.img.url }}"
                            alt="Foto de perfil">
                        {% else %}
                        <i class="bi bi-person display-1 text-secondary"></i>
                        {% endif %}
                    </div>
                    <button class="photo-button btn position-absolute bottom-0 end-0 border border-2 border-secondary rounded-circle m-3 fs-2 fw-bolder"
                        data-bs-toggle="modal" data-bs-target="#photoModal">
                        <i class="bi bi-pencil"></i>
                    </button>
                </div>
            </div>

            <!-- Formulario datos personales -->
            <div class="col-md-12 col-md-12 col-xl-4">
                <form action="{% url 'update-self-user' %}" method="post" class="h-100">
                    {% csrf_token %}
                    <div class="d-flex flex-column h-100">
                        <div class="d-flex flex-wrap gap-3">
                            <div class="mb-3 flex-grow-1">
                                <label class="form-label fw-semibold small text-uppercase text-muted" for="id_first_name">Nombre:</label>
                                {{ UsuarioChangeForm.first_name }}
                            </div>
                            <div class="mb-3 flex-grow-1">
                                <label class="form-label fw-semibold small text-uppercase text-muted" for="id_last_name">Apellidos:</label>
                                {{ UsuarioChangeForm.last_name }}
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-3">
                            <div class="mb-3 flex-grow-1">
                                <label class="form-label fw-semibold small text-uppercase text-muted" for="id_email">Correo electrónico:</label>
                                {{ UsuarioChangeForm.email }}
                            </div>
                            <div class="mb-3 flex-grow-1">
                                <label class="form-label fw-semibold small text-uppercase text-muted" for="id_telefono">Teléfono:</label>
                                {{ UsuarioChangeForm.telefono }}
                            </div>
                        </div>
                        <div class="mt-auto d-flex">
                            <button class="btn btn-outline-black m-auto" type="submit">
                                <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Formulario cambio contraseña -->
            <div class="col-md-12 col-md-12 col-xl-4">
                <form action="{% url 'update-self-password' %}" method="post" class="h-100">
                    {% csrf_token %}
                    <div class="d-flex flex-column h-100">
                        <div class="mb-3">
                            <label class="form-label fw-semibold small text-uppercase text-muted" for="id_old_password">Contraseña antigua:</label>
                            <input class="form-control" type="password" name="old_password" id="id_old_password" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold small text-uppercase text-muted" for="id_new_password1">Contraseña nueva:
                                <i class="bi bi-question-circle cursor-pointer" data-bs-toggle="tooltip" 
                                   title="- Mínimo 8 caracteres&#10;- No debe ser común&#10;- Mezcla de letras y números"></i>
                            </label>
                            <input class="form-control" type="password" name="new_password1" id="id_new_password1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-semibold small text-uppercase text-muted" for="id_new_password2">Confirmar contraseña:</label>
                            <input class="form-control" type="password" name="new_password2" id="id_new_password2" required>
                        </div>
                        <div class="mt-auto d-flex">
                            <button class="btn btn-outline-black m-auto" type="submit">
                                <i class="bi bi-arrow-clockwise me-1"></i> Actualizar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Elemento decorativo -->
<i class="bi bi-person position-absolute top-0 start-0"
    style="font-size: 30rem; transform: rotate(-45deg) translate(7rem, -12rem); color: #7878781c; z-index: -1;"></i>

<script>
    // Vista previa de imagen
    document.getElementById('imageUpload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('uploadPreview');
        const icon = document.getElementById('uploadIcon');
        
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('d-none');
                icon.classList.add('d-none');
            }
            reader.readAsDataURL(file);
        } else {
            preview.src = "";
            preview.classList.add('d-none');
            icon.classList.remove('d-none');
        }
    });
    
    // Inicializar tooltips
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>

{% endblock content_dashboard %}