{% extends "dashboard_template.html" %}
{% load static %}

{% block content_dashboard %}
<style>
    section {
        display: flex;
        position: relative;
        overflow: hidden;
    }

    /* Oculta las barras de scroll pero mantiene el desplazamiento */
    .overflow-y-scroll-hidden {
        overflow-y: scroll;
        scrollbar-width: none;
        /* Firefox */
        -ms-overflow-style: none;
        /* IE 10+ */
    }

    /* Para Chrome, Edge, Safari */
    .overflow-y-scroll-hidden::-webkit-scrollbar {
        display: none;
    }

    .card:hover {
        .w-auto.h-100.object-fit-cover.transition-200 {
            transform: scale(1.05);
            filter: grayscale(0);
        }

        .w-100.h-auto.object-fit-cover.position-absolute.transition-200 {
            transform: scale(1.5) rotateZ(-10deg);
            filter: grayscale(0);
        }

    }
</style>
<div class="border border-2 border-secondary-subtle rounded-2 w-100 overflow-auto">
    <div class="container-fluid d-flex justify-content-end align-items-center p-4">
        <div class="dropdown">
            <button
                class="btn btn-sm btn-ghost-black border border-secondary-subtle d-flex align-items-center justify-content-center bg-opacity-25 rounded-circle transition-200 p-2"
                style="width: 2.5rem; height: 2.5rem;" data-bs-toggle="dropdown" aria-expanded="false"
                data-bs-toggle-tooltip="tooltip" title="Ver listado de solicitudes." id="dropdownCartButton"
                hx-get="{% url 'ver_solicitud_api' %}" hx-target="#SolicitudModalContent" hx-swap="innerHTML"
                hx-trigger="click">
                <i class="bi bi-cart"></i>
            </button>
            <div class="dropdown-menu p-3 bg-invert" aria-labelledby="dropdownCartButton"
                style="width: auto; min-width: 25rem; max-height: 80vh;" data-bs-auto-close="outside">
                <!-- Cierre al hacer clic fuera -->
                <div class="position-relative d-flex justify-content-center overflow-hidden h-100">
                    <div id="SolicitudModalContent" class="mt-2 overflow-auto w-100" style="z-index: 2;">
                        <!-- Contenido dinámico -->
                    </div>
                    <i class="bi bi-box position-absolute top-0 start-0"
                        style="font-size: 15rem; transform: rotate(-45deg) translate(3rem, -3rem); color: #7878781c !important; z-index: 1;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid d-flex flex-row flex-wrap gap-3 justify-content-center" id="container-productos">

        {% if productos %}
        {% for ax in productos %}
        <div class="card border border-secondary-subtle transition-all transition-200" style="width: 20rem; font-size: 0.9rem;">
            <!-- Imagen del producto -->
            <div class="bg-light d-flex justify-content-center align-items-center p-3"
                style="height: 12rem; border-bottom: 1px solid #f0f0f0;">
                {% if ax.imagen and ax.imagen.url != " " %}
                <img class="w-100 h-100 object-fit-contain p-2" src="{{ ax.imagen.url }}"
                    alt="Imagen del Producto {{ ax.nombre }} {{ ax.marca|default_if_none:'' }} {{ ax.modelo|default_if_none:'' }}">
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-image-alt text-muted" style="font-size: 2rem;"></i>
                </div>
                {% endif %}
            </div>

            <!-- Cuerpo de la card -->
            <div class="card-body p-3">
                <!-- Título y marca/modelo -->
                <h6 class="fw-semibold mb-1" style="font-size: 1rem;">{{ ax.nombre }}</h6>
                {% if ax.marca or ax.modelo %}
                <small class="text-muted d-block mb-2">{{ ax.marca|default_if_none:"" }} {{ ax.modelo|default_if_none:""
                    }}</small>
                {% endif %}

                <!-- Precio y stock en la misma línea -->
                <div class="d-flex justify-content-between mb-2">
                    <div>
                        <span class="fw-semibold">${{ ax.precio_unitario }}</span>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <small class="fw-semibold">Stock:</small>
                        <small class="rounded px-2 py-1 {% if ax.stock_actual < 4 %}bg-danger text-light{% elif ax.stock_actual > 3 and ax.stock_actual < 6 %}bg-warning text-black{% else %}text-light bg-primary{% endif %}">
                            {{ ax.stock_actual }}
                        </small>
                    </div>
                </div>

                <!-- Proveedor -->
                <div class="mb-2">
                    <small class="fw-semibold d-block text-muted">Proveedor:</small>
                    <small>{{ ax.proveedor }}</small>
                </div>

                <!-- Descripción (opcional: ocultar si es muy larga) -->
                <div class="mb-3">
                    <small class="fw-semibold d-block text-muted">Descripción:</small>
                    <small class="text-truncate d-block" style="max-width: 100%;">{{ ax.descripcion }}</small>
                </div>

                <!-- Controles -->
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center gap-2 border border-secondary-subtle p-1 rounded">
                        <button class="btn btn-sm btn-outline-black px-2 py-0"
                            onclick="let val = parseInt(select_stock_{{ ax.id }}.innerHTML); if (val > 0) select_stock_{{ ax.id }}.innerHTML = val - 1;">
                            -
                        </button>
                        <span class="fw-semibold" id="select_stock_{{ ax.id }}"
                            style="min-width: 15px; text-align: center;">0</span>
                        <button class="btn btn-sm btn-outline-black px-2 py-0"
                            onclick="let val = parseInt(select_stock_{{ ax.id }}.innerHTML); if (val < {{ ax.stock_actual }}) select_stock_{{ ax.id }}.innerHTML = val + 1;">
                            +
                        </button>
                    </div>
                    <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#CarritoModal"
                        onclick="abrirResumenSolicitud({{ ax.id }})">
                        <i class="bi bi-cart me-1"></i> Añadir al carrito
                    </button>
                </div>
            </div>
        </div>
        
        {% endfor %}
        {% else %}
        <div class="border border-2 border-secondary-subtle p-5 bg-secondary-subtle shadow">
            <h1 class="text-center">
                No hay productos registrados.
            </h1>
        </div>
        {% endif %}
    </div>
</div>
<script>
    const _0x446773 = _0x3d25; function _0x3d25(_0x5fbd91, _0x421157) { const _0x1dc90f = _0x1dc9(); return _0x3d25 = function (_0x3d2553, _0x31dd52) { _0x3d2553 = _0x3d2553 - 0x1b0; let _0x3a450a = _0x1dc90f[_0x3d2553]; return _0x3a450a; }, _0x3d25(_0x5fbd91, _0x421157); } (function (_0x4f2469, _0x2b3f5c) { const _0x341914 = _0x3d25, _0x1ee989 = _0x4f2469(); while (!![]) { try { const _0x783f1d = parseInt(_0x341914(0x1c7)) / 0x1 + parseInt(_0x341914(0x1ce)) / 0x2 * (parseInt(_0x341914(0x1c2)) / 0x3) + parseInt(_0x341914(0x1c3)) / 0x4 * (parseInt(_0x341914(0x1c6)) / 0x5) + -parseInt(_0x341914(0x1ca)) / 0x6 * (parseInt(_0x341914(0x1b2)) / 0x7) + parseInt(_0x341914(0x1bd)) / 0x8 * (-parseInt(_0x341914(0x1d5)) / 0x9) + -parseInt(_0x341914(0x1cb)) / 0xa * (parseInt(_0x341914(0x1b8)) / 0xb) + parseInt(_0x341914(0x1bc)) / 0xc; if (_0x783f1d === _0x2b3f5c) break; else _0x1ee989['push'](_0x1ee989['shift']()); } catch (_0x2d8b1a) { _0x1ee989['push'](_0x1ee989['shift']()); } } }(_0x1dc9, 0xaabeb), document[_0x446773(0x1d1)](_0x446773(0x1c5), function () { const _0x3cd2f7 = _0x446773; document['querySelectorAll']('.add-to-cart-btn')[_0x3cd2f7(0x1cc)](_0xd5277b => { const _0xe77ec2 = _0x3cd2f7, _0x9d4424 = _0xd5277b[_0xe77ec2(0x1bb)](_0xe77ec2(0x1d6)), _0x2ad2b3 = document[_0xe77ec2(0x1b0)](_0xe77ec2(0x1d3) + _0x9d4424); function _0x56681e() { const _0x538f0d = _0xe77ec2; if (!_0x2ad2b3) return; const _0x45eece = parseInt(_0x2ad2b3[_0x538f0d(0x1d2)]) || 0x0; _0x45eece <= 0x0 ? (_0xd5277b[_0x538f0d(0x1d0)](_0x538f0d(0x1c8), !![]), _0xd5277b[_0x538f0d(0x1d7)] = _0x538f0d(0x1cf)) : (_0xd5277b['removeAttribute'](_0x538f0d(0x1c8)), _0xd5277b[_0x538f0d(0x1d7)] = 'Añadir\x20al\x20carrito'); } _0x56681e(); if (_0x2ad2b3) { const _0x4eec99 = new MutationObserver(_0x56681e); _0x4eec99[_0xe77ec2(0x1d4)](_0x2ad2b3, { 'childList': !![], 'subtree': !![] }); } _0xd5277b[_0xe77ec2(0x1d1)](_0xe77ec2(0x1c4), function () { const _0x3e93b3 = _0xe77ec2; if (!_0x2ad2b3) { console[_0x3e93b3(0x1c0)](_0x3e93b3(0x1b4) + _0x9d4424); return; } const _0x3a1716 = parseInt(_0x2ad2b3[_0x3e93b3(0x1d2)]) || 0x0; if (_0x3a1716 <= 0x0) { alert(_0x3e93b3(0x1c1)); return; } const _0x425055 = _0x3e93b3(0x1d8) + _0x9d4424 + '/' + _0x3a1716, _0x46db52 = document[_0x3e93b3(0x1b0)](_0x3e93b3(0x1b6)); _0x46db52 && (_0x46db52[_0x3e93b3(0x1d2)] = '<div\x20class=\x22text-center\x22>Cargando...</div>'), fetch(_0x425055, { 'method': _0x3e93b3(0x1b7), 'headers': { 'X-Requested-With': _0x3e93b3(0x1cd) } })[_0x3e93b3(0x1b1)](_0x2544be => { const _0x3e1e6e = _0x3e93b3; if (!_0x2544be['ok']) throw new Error(_0x3e1e6e(0x1b5)); return _0x2544be[_0x3e1e6e(0x1b9)](); })[_0x3e93b3(0x1b1)](_0x9b20aa => { _0x46db52 && (_0x46db52['innerHTML'] = _0x9b20aa); })[_0x3e93b3(0x1b3)](_0x3c2c1d => { const _0x5ace88 = _0x3e93b3; _0x46db52 && (_0x46db52[_0x5ace88(0x1d2)] = _0x5ace88(0x1be) + _0x3c2c1d[_0x5ace88(0x1bf)] + _0x5ace88(0x1c9)), console[_0x5ace88(0x1c0)](_0x5ace88(0x1ba), _0x3c2c1d); }); }), _0xd5277b['addEventListener']('mouseenter', function () { _0x56681e(); }); }); })); function _0x1dc9() { const _0x3becb9 = ['message', 'error', 'La\x20cantidad\x20debe\x20ser\x20mayor\x20a\x20cero.', '12cJiUPO', '4WjMubU', 'click', 'DOMContentLoaded', '5783525LEUZgm', '607284NZQFcF', 'disabled', '</h4>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20</div>', '2910yeKmWK', '2667260FtDqZx', 'forEach', 'XMLHttpRequest', '165184venBXM', 'No\x20hay\x20cantidad\x20seleccionada', 'setAttribute', 'addEventListener', 'innerHTML', 'select_stock_', 'observe', '10915578aFYkOH', 'data-product-id', 'title', '/preparar_solicitud/', 'getElementById', 'then', '5362kCGcVh', 'catch', 'No\x20se\x20encontró\x20el\x20campo\x20de\x20cantidad\x20para\x20el\x20producto\x20', 'Error\x20en\x20la\x20respuesta\x20del\x20servidor.', 'CarritoModalContent', 'GET', '55oqdqJK', 'text', 'Error\x20al\x20cargar\x20contenido:', 'getAttribute', '18275952otFnTr', '8AdmEOQ', '<div\x20class=\x22border\x20border-2\x20border-danger-subtle\x20text-danger\x20bg-danger-subtle\x20w-100\x20rounded-2\x20p-3\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h4\x20class=\x22text-start\x22><i\x20class=\x22bi\x20bi-exclamation-circle\x20me-2\x22></i>Error:</h4>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<hr\x20class=\x22border-bottom\x20border-2\x20border-danger-subtle\x22>\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20<h4\x20class=\x22text-center\x22>']; _0x1dc9 = function () { return _0x3becb9; }; return _0x1dc9(); }

    function abrirResumenSolicitud(productoId) {
        const cantidad = parseInt(document.getElementById('select_stock_' + productoId).innerText) || 0;
        fetch(`/productos/preparar_solicitud/${productoId}/${cantidad}`)
            .then(res => res.text())
            .then(html => {
                document.getElementById('CarritoModalContent').innerHTML = html;
            });
    }
</script>
<div class="modal fade" id="CarritoModal" tabindex="-1" aria-labelledby="CarritoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content overflow-hidden bg-invert shadow p-4">
            <div class="p-3 z-index-overall position-relative" id="CarritoModalContent">
                <!--  EDITAR  -->
                <!--  EDITAR  -->
            </div>
            <i class="bi bi-box position-absolute top-0 start-0"
                style="font-size: 28rem; transform: rotate(-45deg) translate(5rem, -7rem); color: #7878781c !important; z-index: 1;"></i>
        </div>
    </div>
</div>

{% endblock content_dashboard %}